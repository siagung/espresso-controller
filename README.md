## Homekit Enabled Rancillio Espresso Controller ##
Homekit enabled Rancilio Espresso Controller for Rancilio Silvia v5 Espresso Machine

![rancilio silvia](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/rancilio-silvia-mine.jpeg)

this project was possible thanks to the freeRTOS and esp-open-sdk
Also thanks to folowing other projects:
* [maximkulkin/esp-homekit](https://github.com/maximkulkin/esp-homekit.git)
* [maximkulkin/esp-wifi-config](https://github.com/maximkulkin/esp-wifi-config)
* [ravensystem/esp-adv-button](https://github.com/RavenSystem/esp-adv-button.git)

This module is specifically designed to control turning on-and-off Rancilio Silvia v5 Espresso Machine.
Rancilio Silvia has only a momentary switch that while toggled, powers the machine on (when previously off) and off (when previously on).
Additionally Rancilio Silvia uses an internal timer that turns the machine off after 30min

Espresso Controller monitors the internal power state of the espresso machine and controls powering the machine up and down when activated

### Firmware Build ###
1. Clone the project. Next, initialize and sync all submodules (recursively):
```shell
git clone --recursive https://github.com/stellarshenson/espresso-controller.git
cd espresso-controller
git submodule update --init --recursive
```
2. Install [esp-open-sdk](https://github.com/pfalcon/esp-open-sdk), build it with `make toolchain esptool libhal STANDALONE=n`, then edit your PATH and add the generated toolchain bin directory. The path will be something like /path/to/esp-open-sdk/xtensa-lx106-elf/bin
3. Install [esptool.py](https://github.com/themadinventor/esptool) and make it available on your PATH. If you used esp-open-sdk then this is done already. Alternatively you can use the [NodeMCU flasher](https://github.com/nodemcu/nodemcu-flasher/tree/master/Win64/Release)
4. Checkout [esp-open-rtos](https://github.com/SuperHouse/esp-open-rtos) and set SDK_PATH environment variable pointing to it.
5. Build espresso_switch firmware:
```shell
make -C projects/espresso_switch suite
```
Files generated by the make script should be:
```shell
ls firmware
0x00000_rboot.bin  0x10000_blank_0x00_1M.bin  0x10000_blank_config.bin  0x20000_espresso_switch.bin
```
The prefix indicates where in the flash the firmware should be burned, use it when flashing with [esptool.py](https://github.com/themadinventor/esptool) or the [NodeMCU flasher](https://github.com/nodemcu/nodemcu-flasher/tree/master/Win64/Release). Additional settings for flashing of the firmware are: SPI Mode = DOUT, Baudrate = 230400, Flash size = <flash size of your Wemos unit in Mbyte>


### Functionality ###
The device is supposed to control the powering up and down the espresso machine and notify any power changes to the Homekit clients nearby. In the future the device will be able to control the auto-shutdown of the espresso machine (powersaving) and flushing (running water through the group after warm-up). Additionally the firmware will monitor the boiler temperature in the future.

Currently the device extends the following number of output interfaces:
* __Toggle interface__ - controls the toggle switch and works exactly like the momentary switch on the espresso machine front panel
* __Power sense interface__ - senses whether the machine is on or off (and provides notifications to the homekit clients)
* __Status LED__ - indicates the status of the device, fast blink = booting up, slow-blink = AP mode, no blink = connected to the network, SOS blink (3 short, 3 long, 3 short) = problem

Additionally, when connected through the microUSB port to the computer, the device outputs serial diagnostics messages and extends serial commandline. Type *help* to get the list of available commands.

The serial inteface was configured with the __74880 baud rate__

### Typical Circuit Layout ###
You would need the following parts to complete the build
* __Wemos D1 Mini <any>__ - any wemos with 4Mb+ flash works (Mini or Mini Pro)
* __Optocoupler + 330 Resistor__ - used for powersense. The Rancilio Silvia 12V power indicator circuit it very noisy, we would use the optocoupler to provide galvanic isolation between the controller and the espresso machine
* __Relay__ (3.3V level or Relay 5v + NPN transistor and a couple of passive jellybeans) - this needs to switch the 12v noisy circuit. MOSFET will also do, but I'd prefer those to be galvanicaly isolated
* __1 pull-down resistor (33k is ok)__ - power sense circuit is LOW by default and HIGH when 12V power indicator circuit energises the optocoupler
* __1 Status LED + 330 Resistor__ - this is just a status LED. Fast blink = starting up, Slow blink - AP mode, No blink - connected to network 
* __HI-Link 5V power module__ (to power the thing up from mains) - it would be preferred to connect the controller to the mains terminals at the Rancilio power brick. I am figuiring out other options, stay tuned. Voltage for the Wemos D1 must be relatively clean.Wemos has onboard a small 3v3 linear power supply controller. Please keep in mind that Wemos D1 uses 3v3 logic levels :-)

I will publish the full BOM as soon as I finish the PCB build and installation

![circuit layout](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/espresso_switch_bb.png)
![power brick](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/rancilio-brain-annotated.png)

## Circuit and PCB ##
All schematics and PCB files are available in the [misc/board](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board) directory. The bill of materials is up-to-date in the [schematics pdf](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board/espresso_switch_schematics.pdf)

PCB design is for one-sided PCB with a copper pour connected to the GND. [PCB bottom](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board/espresso_switch_pcb_slim_bottom.pdf) and [PCB top](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/espresso_switch_pcb_slim_top.pdf) printouts are available as 300dpi BMPs. Schematics and PCB files were produced with DipTrace

![circuit](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board/espresso_switch_schematics.jpg)
![pcb](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board/espresso_switch_pcb_slim_300dpi.bmp)
![pcb bottom](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board/espresso_switch_pcb_slim_bottom_300dpi.bmp)
![preview](https://github.com/stellarshenson/espresso-controller/blob/master/projects/espresso_switch/misc/board/espresso_switch_pcb_slim_preview.png)

### Installation ###
TBD
